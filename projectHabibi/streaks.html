<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haibibi - Streaks</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="tracker-body">

    <header>
        <div class="logo" data-i18n="streaksTitle">My Streaks ‚öîÔ∏è</div>
        
        <div class="user-controls">
            <button id="openArchiveBtn" class="theme-toggle-btn" title="Archive">üì¶</button>
            <a href="tracker.html" class="theme-toggle-btn" title="Close">‚úï</a>
        </div>
    </header>

    <div class="container" style="padding-bottom: 50px; margin-top: 20px;">
        
        <div class="stats-container" style="grid-template-columns: 1fr 1fr; margin-bottom: 30px;">
            <div class="stat-card streak-hero">
                <div class="emoji-large" id="mainProdIcon">üî•</div>
                <h2 id="mainProdCount">0</h2>
                <p data-i18n="globalFire">Global Fire</p>
            </div>
            
            <div class="stat-card streak-hero" id="cleanShieldCard">
                <div class="emoji-large" id="mainCleanIcon">üõ°Ô∏è</div>
                <h2 id="mainCleanCount">0</h2>
                <p data-i18n="cleanShield">Clean Shield</p>
            </div>
        </div>

        <p class="section-desc" style="text-align: center;" data-i18n="globalFireDesc">
            "Global Fire" grows if you do at least 1 habit from your Tracker.
        </p>

        <hr class="divider">

        <h3 class="section-title" data-i18n="battleZoneTitle">üõ°Ô∏è Battle Zone (Quit Bad Habits)</h3>
        <p class="section-desc" data-i18n="battleZoneDesc">Mark your victories here.</p>
        
        <div id="quitHabitsList" class="streaks-list">
            <p class="loading-text">Loading battles...</p>
        </div>

        <div class="add-streak-box">
            <h3 data-i18n="fightNewTitle">Fight a new addiction</h3>
            <div class="streak-form">
                <input type="text" id="newQuitName" data-i18n-placeholder="fightNewPlaceholder" placeholder="Name (e.g. No Sugar)...">
                <button id="createQuitBtn" class="btn-primary" data-i18n="startFightBtn">Start Fight</button>
            </div>
        </div>

        <hr class="divider">

        <h3 class="section-title" data-i18n="trackerHabitsTitle">‚ú® Tracker Habits (Build)</h3>
        <p class="section-desc" data-i18n="trackerHabitsDesc">Your individual progress on habits from the Main Tracker.</p>
        
        <div id="buildHabitsList" class="streaks-list">
            <p class="loading-text">Loading habits...</p>
        </div>
        
        <div style="text-align: center; margin-top: 25px;">
            <a href="tracker.html" class="toggle-link" data-i18n="goToTracker">Go to Tracker to add more ‚ú®</a>
        </div>

    </div>

    <div id="archiveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-i18n="archiveTitle">Archived Habits</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div id="archiveList"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // –î–û–ë–ê–í–ò–õ deleteDoc –í –ò–ú–ü–û–†–¢ –ù–ò–ñ–ï:
        import { getFirestore, collection, addDoc, query, where, onSnapshot, updateDoc, deleteDoc, doc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { translations } from "./translations.js";

        // --- –í–°–¢–ê–í–¨ –°–í–û–ò –ö–õ–Æ–ß–ò FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyABGlOmgn1cYcOjfO44r9w-XpBuFogVgmM",
            authDomain: "habitpop-d7f60.firebaseapp.com",
            projectId: "habitpop-d7f60",
            storageBucket: "habitpop-d7f60.firebasestorage.app",
            messagingSenderId: "703042488340",
            appId: "1:703042488340:web:07488c051bd83163bc3f01"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let currentHabits = []; 
        let currentLang = localStorage.getItem('lang') || 'en';

        function applyStreaksLanguage() {
            const t = translations[currentLang];
            if (!t) return;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (t[key]) el.innerHTML = t[key];
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.dataset.i18nPlaceholder;
                if (t[key]) el.placeholder = t[key];
            });
        }
        applyStreaksLanguage();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadStreaks(user.uid);
                document.getElementById('mainProdCount').innerText = localStorage.getItem('prodStreak') || 0;
                document.getElementById('mainCleanCount').innerText = localStorage.getItem('cleanStreak') || 0;
            } else {
                window.location.href = "index.html";
            }
        });

        function loadStreaks(uid) {
            const q = query(collection(db, "habits"), where("uid", "==", uid));
            onSnapshot(q, (snapshot) => {
                const habits = [];
                snapshot.forEach(doc => habits.push({ id: doc.id, ...doc.data() }));
                currentHabits = habits; 

                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–∏–≤—ã—á–∫–∏
                const quitHabits = habits.filter(h => h.type === 'quit' && !h.archived);
                const buildHabits = habits.filter(h => (h.type === 'build' || !h.type) && !h.archived);

                // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –°–ï–†–ò–ú –©–ò–¢, –ï–°–õ–ò –ü–£–°–¢–û ---
                const shieldCard = document.getElementById('cleanShieldCard');
                if (quitHabits.length === 0) {
                    shieldCard.classList.add('inactive'); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å —Å–µ—Ä–æ—Å—Ç–∏
                    document.getElementById('mainCleanCount').innerText = '-'; // –°—Ç–∞–≤–∏–º –ø—Ä–æ—á–µ—Ä–∫
                } else {
                    shieldCard.classList.remove('inactive'); // –£–±–∏—Ä–∞–µ–º —Å–µ—Ä–æ—Å—Ç—å
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ü–∏—Ñ—Ä—É –∏–∑ –ø–∞–º—è—Ç–∏
                    document.getElementById('mainCleanCount').innerText = localStorage.getItem('cleanStreak') || 0;
                }
                // ------------------------------------------

                renderQuitSection(quitHabits);
                renderBuildSection(buildHabits);
            });
        }

        function renderQuitSection(habits) {
            const container = document.getElementById('quitHabitsList');
            const t = translations[currentLang];
            
            if(habits.length === 0) {
                container.innerHTML = `<div class="empty-state">No active battles. Start one below!</div>`;
                return;
            }
            const todayStr = new Date().toISOString().split('T')[0];
            let html = '';
            habits.forEach(h => {
                const streak = calculateIndividualStreak(h);
                const isDoneToday = h.checks.includes(todayStr);
                
                let actionBlock = isDoneToday 
                    ? `<div class="status-badge success">${t.heldFirmToday}</div>`
                    : `<div class="battle-buttons">
                            <button class="battle-btn success" onclick="window.markHabit('${h.id}', true)">üí™ ${t.heldFirm}</button>
                            <button class="battle-btn fail" onclick="window.markHabit('${h.id}', false)">‚ö†Ô∏è ${t.relapsed}</button>
                       </div>`;
                
                // –î–û–ë–ê–í–ò–õ –ö–ù–û–ü–ö–£ –£–î–ê–õ–ï–ù–ò–Ø (–ö–†–ï–°–¢–ò–ö) –†–Ø–î–û–ú –° –ò–ú–ï–ù–ï–ú
                html += `<div class="streak-row-card">
                    <div class="streak-info">
                        <h3>‚õî ${h.name} 
                            <button class="delete-streak-btn" onclick="window.deleteStreak('${h.id}')" title="Delete">√ó</button>
                        </h3>
                        <div class="streak-days">Streak: <strong>${streak}</strong></div>
                    </div>
                    <div class="streak-actions">${actionBlock}</div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function renderBuildSection(habits) {
            const container = document.getElementById('buildHabitsList');
            if(habits.length === 0) {
                container.innerHTML = `<div class="empty-state">No active habits.</div>`;
                return;
            }
            let html = '';
            habits.forEach(h => {
                const streak = calculateIndividualStreak(h);
                html += `<div class="streak-row-card compact">
                    <div class="streak-info"><h3>‚ú® ${h.name}</h3></div>
                    <div class="streak-count-badge">üî• ${streak}</div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function calculateIndividualStreak(habit) {
            let streak = 0;
            let checkDate = new Date();
            const todayStr = new Date().toISOString().split('T')[0];
            if (!habit.checks.includes(todayStr)) checkDate.setDate(checkDate.getDate() - 1);
            while (true) {
                if (habit.checks.includes(checkDate.toISOString().split('T')[0])) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else break;
            }
            return streak;
        }

        window.markHabit = async (id, isSuccess) => {
            if (isSuccess) {
                await updateDoc(doc(db, "habits", id), { checks: arrayUnion(new Date().toISOString().split('T')[0]) });
                if (navigator.vibrate) navigator.vibrate([50]);
            } else {
                alert("It's okay. Reset and start again tomorrow.");
            }
        };

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –£–î–ê–õ–ï–ù–ò–Ø
        window.deleteStreak = async (id) => {
            if(confirm("Delete this battle forever?")) {
                await deleteDoc(doc(db, "habits", id));
            }
        };

        document.getElementById('createQuitBtn').addEventListener('click', async () => {
            const name = document.getElementById('newQuitName').value;
            if (name && currentUser) {
                await addDoc(collection(db, "habits"), {
                    uid: currentUser.uid, name: name, type: 'quit', checks: [], createdAt: Date.now(), archived: false
                });
                document.getElementById('newQuitName').value = '';
            }
        });

        // –ê—Ä—Ö–∏–≤–∞—Ü–∏—è
        const modal = document.getElementById("archiveModal");
        const openBtn = document.getElementById("openArchiveBtn");
        const closeBtn = document.querySelector(".close-modal");
        
        if(openBtn) openBtn.onclick = () => { modal.style.display = "block"; renderArchiveList(); }
        if(closeBtn) closeBtn.onclick = () => modal.style.display = "none";
        window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; }

        function renderArchiveList() {
            const list = document.getElementById('archiveList');
            const t = translations[currentLang];
            const archived = currentHabits.filter(h => h.archived);
            if (archived.length === 0) { list.innerHTML = `<p style="text-align:center;color:#888;">${t.emptyArchive}</p>`; return; }
            let html = '';
            archived.forEach(h => {
                html += `<div class="archive-item"><span class="archive-name">${h.name}</span>
                <div class="archive-actions"><button class="rate-btn" onclick="window.restoreHabit('${h.id}')">‚Ü©Ô∏è</button></div></div>`;
            });
            list.innerHTML = html;
        }
        window.restoreHabit = async (id) => {
            if(confirm('Restore?')) { await updateDoc(doc(db, "habits", id), { archived: false }); renderArchiveList(); }
        };
    </script>
</body>
</html>